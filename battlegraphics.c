/* * File: battlegraphics.c * Last modified on Mon Feb 8 21:11:00 1995 by jzelenski * ----------------------------------------------------- * Implementation of the battlegraphics module:  a set of drawing routines  * to support the graphics for the Battleship game.   It is fairly sparsely * commented, so peruse at your own risk... */ #include "battlegraphics.h"#include "extgraph.h"#include "stdarg.h"	#define UPPER_LEFT_X .35		// position of upper-left corner of grid#define UPPER_LEFT_Y 3.65#define SQUARE_SIZE .30  		// size of each cell in the board#define LABEL_OFFSET .15		// distance between labels and grid#define FONT "Helvetica"		// font and size used for labels#define FONT_SIZE 12 #define FONT_COLOR "White"	#define SCORE_X (UPPER_LEFT_X + NUM_COLS*SQUARE_SIZE + .25)#define SCORE_Y (UPPER_LEFT_Y - SQUARE_SIZE*5) 	// score is just to right of grid#define MESSAGE_X (UPPER_LEFT_X)			// message is just below grid#define MESSAGE_Y (UPPER_LEFT_Y - NUM_ROWS*SQUARE_SIZE - .35)   #define GRID_COLOR "Red"		// grid color					#define SUNK_DENSITY .25		// density to fill sunk diamonds#define HIT_DENSITY .75			// density to fill hit diamondstypedef enum {LeftAligned, RightAligned, Centered} alignmentT;	// for text alignmentsstatic void LabelAxes(void);static bool ValidLocation(coord coord);static void MarkSquare(coord coord, string color, double fill);static void DrawDiamond(double lowerLeftX, double lowerLeftY, double squareSize, double fill, string color);static void DrawX(double lowerLeftX, double lowerLeftY, double squareSize);static void DrawCenteredText(double cx, double cy, string str);static void DrawFormattedText(double x, double y, alignmentT align, string format,...);static void DrawBoxedGrid(double x, double y, double width, double height,			  int columns, int rows);void DrawStartingBoard(void){       	DrawBoxedGrid(UPPER_LEFT_X, UPPER_LEFT_Y - NUM_ROWS*SQUARE_SIZE,				  SQUARE_SIZE, SQUARE_SIZE, NUM_COLS, NUM_ROWS);	LabelAxes(); }// Predicate value if a coord is valid for this board static bool ValidLocation(coord coord){	return (coord.row >= 0) && (coord.row < NUM_ROWS)		&& (coord.col >= 0) && (coord.col < NUM_COLS);}// Used to verify coord and halt with error if coord is out of bounds static void CheckBounds(coord coord){	if (!ValidLocation(coord))		Error("(%c, %d) is out of bounds for this board!", coord.row + 'A', coord.col);}// Called by both MarkHit & MarkSunk (with different color & fill)static void MarkSquare(coord coord, string color, double fill){	CheckBounds(coord);			// will halt with error if invalid location	DrawDiamond(UPPER_LEFT_X + coord.col*SQUARE_SIZE,				UPPER_LEFT_Y - (coord.row+1)*SQUARE_SIZE, 				SQUARE_SIZE, fill, color);}void MarkHit(coord coord, string color){	MarkSquare(coord, color, HIT_DENSITY);}void MarkMiss(coord coord){	CheckBounds(coord);			// will halt with error if invalid location	DrawX(UPPER_LEFT_X + coord.col*SQUARE_SIZE,		  UPPER_LEFT_Y - (coord.row+1)*SQUARE_SIZE,		  SQUARE_SIZE);}// Marks all squares between start and stop.  Assumes that start is// "smaller" than end, note the bounds on the two for loops.  It can// deal with horizontal and vertical orientations (actually diagonal, too// but the interface doesn't quote this)// ----------------------void MarkLineAsSunk(coord start, coord end, string color){	coord current;		for (current.row = start.row; current.row <= end.row; current.row++)		for (current.col = start.col; current.col <= end.col; current.col++)			MarkSquare(current, color, SUNK_DENSITY);}// Waits for user to click the mouse (mouse up followed by mouse down)// Then determines where the mouse position falls on the board.  If// it is a valid cell, returns the coord.  Otherwise returns {-1,-1}// as cell location// ----------------------coord GetLocationChosenByUser(){	coord hit;		WaitForMouseDown();	WaitForMouseUp();	hit.row = (int)((UPPER_LEFT_Y - GetMouseY())/SQUARE_SIZE);	hit.col = (int)((GetMouseX() - UPPER_LEFT_X)/SQUARE_SIZE);	if (!ValidLocation(hit)) hit.row = hit.col = -1;	return hit;}// Draws missiles, ships, and accuracy over on the right side.// Fills a big background square first in order to erase any previous text.void DrawScore(int missilesLeft, int shipsLeft, double accuracy){	DrawFilledBox(SCORE_X, SCORE_Y, GetWindowWidth()-SCORE_X, GetWindowHeight()-SCORE_Y, BOX_COLOR);	// Erase old information	DrawFormattedText(SCORE_X,SCORE_Y+4*GetFontHeight(), LeftAligned, 					"Missiles left:  %d", missilesLeft);	DrawFormattedText(SCORE_X,SCORE_Y+2*GetFontHeight(), LeftAligned, 					"Ships to sink:  %d", shipsLeft);	DrawFormattedText(SCORE_X,SCORE_Y, LeftAligned, 					"Hit rate:  %.0f%%", accuracy*100);}// Using vsprintf to process the var args, builds up a formatting string// and writes to location (MESSAGE_X, MESSAGE_Y) on the graphics window.// Fills a big white square first in order to erase any previous text.// Draws the text in black, using the current font.void DrawPrintfMessage(string format,...){	va_list args;	char buffer[1024];	va_start(args, format);	vsprintf(buffer, format, args);	va_end(format);	DrawFilledBox(MESSAGE_X, 0, GetWindowWidth(), GetFontHeight() + MESSAGE_Y, BOX_COLOR);	MovePen(MESSAGE_X, MESSAGE_Y);	SetPenColor(FONT_COLOR);	DrawTextString(buffer);}// Using vsprintf to process the var args, builds up a formatting string// and writes to specified location on the graphics window.// Draws the text in FONT_COLOR, using the current font.static void DrawFormattedText(double x, double y, alignmentT align, string format,...){	va_list args;	char buffer[1024];	va_start(args, format);	vsprintf(buffer, format, args);	va_end(format);	SetPenColor(FONT_COLOR);	if (align == Centered) {		DrawCenteredText(x,y,buffer);	} else {		MovePen(x, y);		DrawTextString(buffer);	}}static void DrawDiamond(double lowerLeftX, double lowerLeftY, double squareSize, double fill, string color){	SetPenColor(color);	MovePen(lowerLeftX,lowerLeftY + squareSize/2); // move to left side of diamond	StartFilledRegion(fill);	DrawLine(squareSize/2, squareSize/2);	// draw up to top point	DrawLine(squareSize/2, -squareSize/2);	// draw down to right side	DrawLine(-squareSize/2, -squareSize/2);	// draw down to bottom point	DrawLine(-squareSize/2, squareSize/2);	// draw back to left side	EndFilledRegion();}static void DrawX(double lowerLeftX, double lowerLeftY, double squareSize){	SetPenColor(GRID_COLOR);	MovePen(lowerLeftX,lowerLeftY);				// move to lower-left corner	DrawLine(squareSize, squareSize);			// draw to upper-right corner	MovePen(lowerLeftX, lowerLeftY+squareSize);	// move to upper-left corner	DrawLine(squareSize, -squareSize);			// draw down to lower-right corner}void DrawBox(double lowerLeftX, double lowerLeftY, double width, double height){	MovePen(lowerLeftX, lowerLeftY);	DrawLine(width,0);	DrawLine(0,height);	DrawLine(-width,0);	DrawLine(0,-height);}void DrawFilledBox(double lowerLeftX, double lowerLeftY, double width, double height, double fill){	SetPenColor("Black");	StartFilledRegion(fill);	DrawBox(lowerLeftX, lowerLeftY, width, height);	EndFilledRegion();}static void DrawBoxedGrid(double x, double y, double width, double height,			  int numColumns, int numRows){	int i, j;		SetPenColor(GRID_COLOR);	for (i = 0; i < numColumns; i++)		for (j = 0; j < numRows; j++)			DrawBox(x + i * width, y + j * height, width, height);}// Horizontally AND vertically centers the text around the specified point// given the metrics of the current font setting.static void DrawCenteredText(double centerX, double centerY, string str){	MovePen(centerX - TextStringWidth(str)/2, centerY - GetFontAscent()/2);	DrawTextString(str);}// Labels the grid axes.  Columns are numbered from 0 to NUM_COLS -1 along the// top edge of the grid.  Rows are lettered from 'A' down along the left edge// of the grid.  Uses the DrawFormattedText function to aesthetically center// each label.static void LabelAxes(){	int row, col;		SetFont(FONT);	SetPointSize(FONT_SIZE);	for (row = 0; row < NUM_ROWS; row++)		DrawFormattedText(UPPER_LEFT_X - LABEL_OFFSET, 					UPPER_LEFT_Y - (row +.5)*SQUARE_SIZE, 					Centered, "%c", 'A' + row);	for (col = 0; col < NUM_COLS; col++)		DrawFormattedText(UPPER_LEFT_X + (col+.5)*SQUARE_SIZE, 					UPPER_LEFT_Y + LABEL_OFFSET,					Centered, "%d", col);}